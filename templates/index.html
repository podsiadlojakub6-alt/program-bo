<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Kalkulator Decyzji i Gier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .input-cell { width: 80px; text-align: center; border: 1px solid #e2e8f0; padding: 6px; border-radius: 6px; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 p-4">
    <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-6">
        <div class="flex border-b mb-6">
            <button onclick="setMode('bo')" id="tab-bo" class="px-6 py-3 font-bold text-slate-500 hover:text-blue-600 transition">Kryteria Decyzyjne</button>
            <button onclick="setMode('game')" id="tab-game" class="px-6 py-3 font-bold text-slate-500 hover:text-blue-600 transition">Gry Strategiczne</button>
        </div>

        <form method="POST" id="mainForm">
            <input type="hidden" name="mode" id="formMode" value="{{ mode }}">
            
            <div class="flex justify-between items-center mb-4">
                <h2 id="modeTitle" class="text-xl font-bold text-slate-800">Macierz Wypłat</h2>
                <div class="flex gap-2">
                    <button type="button" onclick="addRow()" class="bg-emerald-500 text-white px-3 py-1 rounded text-sm font-bold">+ Wiersz</button>
                    <button type="button" onclick="addColumn()" class="bg-emerald-500 text-white px-3 py-1 rounded text-sm font-bold">+ Kolumna</button>
                </div>
            </div>

            <div class="overflow-x-auto mb-6">
                <table id="matrixTable" class="w-full">
                    <thead class="bg-slate-50">
                        <tr id="deleteHeaderRow"><th></th><th class="p-1"><button type="button" onclick="removeCol(1)" class="text-rose-500 text-xs font-bold">USUŃ</button></th><th class="p-1"><button type="button" onclick="removeCol(2)" class="text-rose-500 text-xs font-bold">USUŃ</button></th><th></th></tr>
                        <tr id="headerRow">
                            <th class="p-2 text-xs text-slate-400"></th><th class="p-2 text-xs text-slate-400">G2: S1</th><th class="p-2 text-xs text-slate-400">G2: S2</th><th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y">
                        <tr><td class="p-2 font-bold text-slate-600 text-sm">G1: W1</td><td><input name="cell_0_0" class="input-cell" value="0"></td><td><input name="cell_0_1" class="input-cell" value="0"></td><td><button type="button" onclick="removeRow(this)" class="text-rose-400 font-bold px-2">×</button></td></tr>
                        <tr><td class="p-2 font-bold text-slate-600 text-sm">G1: W2</td><td><input name="cell_1_0" class="input-cell" value="0"></td><td><input name="cell_1_1" class="input-cell" value="0"></td><td><button type="button" onclick="removeRow(this)" class="text-rose-400 font-bold px-2">×</button></td></tr>
                    </tbody>
                </table>
            </div>

            <div id="bo-options" class="mb-6 flex gap-4 items-center bg-slate-50 p-4 rounded-xl">
                <label class="text-sm font-bold text-slate-500 uppercase">Gamma (Hurwicz):</label>
                <input type="number" step="0.1" name="gamma" value="0.6" class="w-20 p-2 border rounded text-center font-bold">
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition">OBLICZ</button>
        </form>

        {% if results %}
        <div class="mt-8 p-6 bg-slate-900 rounded-2xl text-white">
            {% if results.type == 'bo' %}
                <h3 class="text-blue-400 font-bold mb-4 uppercase tracking-widest text-sm">Wyniki: Decyzje w warunkach niepewności</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><p class="text-xs text-slate-400">Wald</p><p class="text-xl font-bold">Wariant {{ results.wald.idx }}</p></div>
                    <div><p class="text-xs text-slate-400">Hurwicz</p><p class="text-xl font-bold">Wariant {{ results.hurwicz.idx }}</p></div>
                    <div><p class="text-xs text-slate-400">Bayes</p><p class="text-xl font-bold">Wariant {{ results.bayes.idx }}</p></div>
                    <div><p class="text-xs text-slate-400">Savage</p><p class="text-xl font-bold">Wariant {{ results.savage.idx }}</p></div>
                </div>
            {% else %}
                <h3 class="text-emerald-400 font-bold mb-4 uppercase tracking-widest text-sm">Wyniki: Teoria Gier</h3>
                <div class="space-y-2">
                    <p>Dolna wartość gry (Maximin): <span class="font-bold">{{ results.data.maximin }}</span></p>
                    <p>Górna wartość gry (Minimax): <span class="font-bold">{{ results.data.minimax }}</span></p>
                    <hr class="border-slate-700 my-2">
                    {% if results.data.is_stable %}
                        <p class="text-emerald-400 font-bold">Znaleziono punkt siodłowy!</p>
                        <p>Wartość gry: <span class="text-2xl font-black">{{ results.data.saddle_point.val }}</span></p>
                        <p class="text-sm text-slate-400">Optymalna strategia: Gracz 1: W{{ results.data.saddle_point.row }}, Gracz 2: S{{ results.data.saddle_point.col }}</p>
                    {% else %}
                        <p class="text-rose-400 font-bold">Gra nie ma punktu siodłowego (gra niestabilna).</p>
                        <p>Należy zastosować strategie mieszane.</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        function setMode(mode) {
            document.getElementById('formMode').value = mode;
            document.getElementById('tab-bo').className = mode === 'bo' ? 'px-6 py-3 font-bold tab-active' : 'px-6 py-3 font-bold text-slate-500';
            document.getElementById('tab-game').className = mode === 'game' ? 'px-6 py-3 font-bold tab-active' : 'px-6 py-3 font-bold text-slate-500';
            document.getElementById('bo-options').style.display = mode === 'bo' ? 'flex' : 'none';
            document.getElementById('modeTitle').innerText = mode === 'bo' ? 'Macierz Decyzyjna' : 'Macierz Gry (Suma Zerowa)';
        }
        // Wywołanie na start
        setMode('{{ mode }}' || 'bo');

        function updateNames() {
            const rows = document.querySelectorAll('#tableBody tr');
            const mode = document.getElementById('formMode').value;
            rows.forEach((row, i) => {
                row.cells[0].innerText = (mode === 'bo' ? 'W' : 'G1: W') + (i + 1);
                row.querySelectorAll('input').forEach((input, j) => { input.name = `cell_${i}_${j}`; });
            });
            const headerCells = document.querySelectorAll('#headerRow th');
            for(let i = 1; i < headerCells.length - 1; i++) {
                headerCells[i].innerText = (mode === 'bo' ? 'Stan ' : 'G2: S') + i;
            }
        }
        
        function addRow() {
            const body = document.getElementById('tableBody');
            const colCount = document.getElementById('headerRow').cells.length - 2;
            const row = document.createElement('tr');
            let cells = `<td class="p-2 font-bold text-slate-600 text-sm"></td>`;
            for (let i = 0; i < colCount; i++) cells += `<td><input class="input-cell" value="0"></td>`;
            cells += `<td><button type="button" onclick="removeRow(this)" class="text-rose-400 font-bold px-2">×</button></td>`;
            row.innerHTML = cells;
            body.appendChild(row);
            updateNames();
        }

        function addColumn() {
            const delH = document.getElementById('deleteHeaderRow'), head = document.getElementById('headerRow'), rows = document.querySelectorAll('#tableBody tr');
            const newIdx = head.cells.length - 1;
            const thD = document.createElement('th'); thD.className="p-1"; thD.innerHTML=`<button type="button" onclick="removeCol(${newIdx})" class="text-rose-500 text-xs font-bold">USUŃ</button>`;
            delH.insertBefore(thD, delH.lastElementChild);
            const th = document.createElement('th'); th.className="p-2 text-xs text-slate-400";
            head.insertBefore(th, head.lastElementChild);
            rows.forEach(r => {
                const td = document.createElement('td'); td.innerHTML=`<input class="input-cell" value="0">`;
                r.insertBefore(td, r.lastElementChild);
            });
            updateNames();
        }

        function removeRow(btn) { if(document.querySelectorAll('#tableBody tr').length > 1) { btn.closest('tr').remove(); updateNames(); } }
        function removeCol(idx) {
            const delH = document.getElementById('deleteHeaderRow'), head = document.getElementById('headerRow'), rows = document.querySelectorAll('#tableBody tr');
            if(head.cells.length > 3) {
                delH.deleteCell(idx); head.deleteCell(idx); rows.forEach(r => r.deleteCell(idx));
                delH.querySelectorAll('button').forEach((b, i) => b.setAttribute('onclick', `removeCol(${i+1})`));
                updateNames();
            }
        }
    </script>
</body>
</html>
